<!doctype html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1" name="viewport"/>
    <title>Trade Page · Demo</title>
    <style>
        :root {
            --bg: #0f1115;
            --panel: #171a21;
            --muted: #2a2f3a;
            --text: #e7eaf0;
            --sub: #a6adbb;
            --buy: #1f8a4c;
            --sell: #a83a3a;
            --accent: #2f81f7;
            --ok: #1f8a4c;
            --warn: #a83a3a;
        }

        * {
            box-sizing: border-box
        }

        html, body {
            height: 100%
        }

        body {
            margin: 0;
            font: 14px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Noto Sans", "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", sans-serif;
            color: var(--text);
            background: var(--bg);
        }

        .container {
            max-width: 1320px;
            margin: 0 auto;
            padding: 16px;
            display: grid;
            grid-template-columns: 360px 1fr;
            grid-gap: 16px;
        }

        /* Panels */
        .panel {
            background: var(--panel);
            border: 1px solid var(--muted);
            border-radius: 12px;
            overflow: hidden
        }

        .panel-header {
            padding: 10px 12px;
            border-bottom: 1px solid var(--muted);
            display: flex;
            align-items: center;
            justify-content: space-between
        }

        .title {
            font-weight: 700
        }

        .sub {
            color: var(--sub);
            font-size: 12px
        }

        .panel-body {
            padding: 10px 12px
        }

        /* Order book */
        table {
            width: 100%;
            border-collapse: collapse
        }

        th, td {
            padding: 8px 6px;
            text-align: right
        }

        th {
            text-align: right;
            color: var(--sub);
            font-weight: 600;
            font-size: 12px
        }

        tr + tr td {
            border-top: 1px dashed #242a35
        }

        .row-buy {
            background: linear-gradient(90deg, rgba(31, 138, 76, .15), transparent)
        }

        .row-sell {
            background: linear-gradient(90deg, rgba(168, 58, 58, .15), transparent)
        }

        .price {
            font-variant-numeric: tabular-nums
        }

        .qty {
            font-variant-numeric: tabular-nums
        }

        .side-b {
            color: var(--buy)
        }

        .side-s {
            color: var(--sell)
        }

        /* Chart placeholder */
        #kline {
            height: 420px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--sub);
            background: radial-gradient(transparent 0 74%, rgba(255, 255, 255, .02) 74% 100%),
            linear-gradient(#131722, #11141a);
        }

        /* Order form */
        .form {
            display: grid;
            grid-template-columns:1fr 1fr;
            grid-gap: 10px
        }

        .form .col-span-2 {
            grid-column: 1 / -1
        }

        label {
            display: block;
            margin: 0 0 6px 2px;
            color: var(--sub);
            font-size: 12px
        }

        input, select {
            width: 100%;
            padding: 10px 12px;
            border-radius: 10px;
            border: 1px solid var(--muted);
            background: #0e1218;
            color: var(--text);
            outline: none;
        }

        input:focus, select:focus {
            border-color: #3a4454
        }

        .btn {
            appearance: none;
            border: 0;
            padding: 12px 14px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 700;
        }

        .btn-buy {
            background: var(--buy);
            color: #fff
        }

        .btn-sell {
            background: var(--sell);
            color: #fff
        }

        .btn:active {
            transform: translateY(1px)
        }

        .hint {
            font-size: 12px;
            color: var(--sub)
        }

        /* Bottom trades bar */
        .bottom {
            grid-column: 1 / -1
        }

        .trades {
            max-height: 240px;
            overflow: auto
        }

        .flex {
            display: flex;
            gap: 10px;
            align-items: center
        }

        .pill {
            padding: 2px 8px;
            border-radius: 999px;
            font-size: 12px;
            border: 1px solid var(--muted);
            color: var(--sub)
        }

        .mono {
            font-variant-numeric: tabular-nums
        }

        /* Responsive */
        @media (max-width: 960px) {
            .container {
                grid-template-columns:1fr
            }
        }
    </style>
</head>
<body>
<div class="container">

    <!-- Left: Order Book -->
    <section class="panel" id="orderbook">
        <div class="panel-header">
            <div class="title">订单簿 Order Book</div>
            <div class="sub">BTC/USDT</div>
        </div>
        <div class="panel-body">
            <div style="display:grid; grid-template-columns:1fr; gap:10px">
                <div class="panel" style="border:none">
                    <div class="panel-header"><span class="title">卖盘 Asks</span><span class="pill">Top 20</span></div>
                    <div class="panel-body" style="padding-top:0">
                        <table id="asks">
                            <thead>
                            <tr>
                                <th>价格</th>
                                <th>数量</th>
                                <th>累计</th>
                            </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
                <div class="panel" style="border:none">
                    <div class="panel-header"><span class="title">买盘 Bids</span><span class="pill">Top 20</span></div>
                    <div class="panel-body" style="padding-top:0">
                        <table id="bids">
                            <thead>
                            <tr>
                                <th>价格</th>
                                <th>数量</th>
                                <th>累计</th>
                            </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Right: K-line + Order Form -->
    <section class="panel">
        <div class="panel-header">
            <div class="title">行情 K线</div>
            <div class="flex">
                <span class="pill">1m</span><span class="pill">5m</span><span class="pill">1h</span><span class="pill">1d</span>
            </div>
        </div>
        <div class="panel-body">
            <div id="kline">K 线占位</div>
        </div>

        <div class="panel-header">
            <div class="title">下单 Order Form</div>
            <div class="sub">支持：限价 / 市价 · GTC / IOC / FOK</div>
        </div>
        <div class="panel-body">
            <form class="form" id="orderForm" onsubmit="return false">
                <div>
                    <label for="side">方向</label>
                    <select id="side">
                        <option value="BID">买入 (BUY)</option>
                        <option value="ASK">卖出 (SELL)</option>
                    </select>
                </div>
                <div>
                    <label for="type">类型</label>
                    <select id="type">
                        <option value="LIMIT">限价单</option>
                        <option value="MARKET">市价单</option>
                        <option value="STOP">止损单</option>
                    </select>
                </div>
                <div>
                    <label for="price">价格</label>
                    <input id="price" placeholder="例如 104" step="0.01" type="number"/>
                </div>
                <div>
                    <label for="qty">数量</label>
                    <input id="qty" placeholder="例如 1.0" step="0.0001" type="number"/>
                </div>
                <div>
                    <label for="tif">有效时间 (TIF)</label>
                    <select id="tif">
                        <option value="GTC">GTC</option>
                        <option value="IOC">IOC</option>
                        <option value="FOK">FOK</option>
                    </select>
                </div>
                <div class="col-span-2" style="display:flex; gap:10px">
                    <button class="btn btn-buy" id="btnBuy">买入</button>
                    <button class="btn btn-sell" id="btnSell">卖出</button>
                </div>
            </form>
        </div>
    </section>

    <!-- Bottom: Trades -->
    <section class="panel bottom" id="tradesPanel">
        <div class="panel-header">
            <div class="title">成交列表 Trades</div>
            <div class="sub">最近成交（实时）</div>
        </div>
        <div class="panel-body trades">
            <table id="trades">
                <thead>
                <tr>
                    <th style="text-align:left">symbol</th>
                    <th>takerOrderId</th>
                    <th>takerSide</th>
                    <th>makerOrderId</th>
                    <th>price</th>
                    <th>qty</th>
                    <th>tradeTime</th>
                </tr>
                </thead>
                <tbody></tbody>
            </table>

        </div>
    </section>

</div>

<script>

    /** -----------------------
     *  Depth WebSocket
     *  ----------------------*/
    const DEPTH_URL = "ws://localhost:8080/ws/depth";
    const TOP_N = 20;                           // 只展示前 N 档
    const fmt = (n, d = 2) => Number(n).toLocaleString(
        undefined, {minimumFractionDigits: d, maximumFractionDigits: d}
    );
    let depthSocket, retry = 0;

    // socket链接与数据渲染
    function connectDepth() {
        depthSocket = new WebSocket(DEPTH_URL);

        depthSocket.onopen = () => {
            retry = 0;
        };

        depthSocket.onmessage = (e) => {
            // 服务端： [bidsMap, asksMap]
            const arr = JSON.parse(e.data);
            const bidsMap = arr[0] || {};
            const asksMap = arr[1] || {};

            // map -> [{price, qty}]
            const bids = Object.entries(bidsMap)
                .map(([p, q]) => ({price: parseFloat(p), qty: Number(q)}))
                .filter(r => r.qty > 0);
            const asks = Object.entries(asksMap)
                .map(([p, q]) => ({price: parseFloat(p), qty: Number(q)}))
                .filter(r => r.qty > 0);

            // 排序：买盘降序（从最优买价开始），卖盘升序（从最优卖价开始）
            let cum = 0;
            bids.sort((a, b) => b.price - a.price).slice(0, TOP_N).forEach(r => r._cum = (cum += r.qty));
            cum = 0;
            asks.sort((a, b) => b.price - a.price).slice(0, TOP_N).reverse().forEach(r => r._cum = (cum += r.qty));
            renderBook("#bids", bids, /*isAsk=*/false);
            renderBook("#asks", asks, /*isAsk=*/true);
        };

        depthSocket.onclose = () => {
            // 指数退避重连
            const delay = Math.min(30000, 1000 * Math.pow(2, retry++));
            setTimeout(connectDepth, delay);
        };

        depthSocket.onerror = () => {
            try {
                depthSocket.close();
            } catch {
            }
        };
    }

    function renderBook(tableSelector, rows, isAsk) {
        const tbody = document.querySelector(`${tableSelector} tbody`);
        if (!tbody) return;

        tbody.innerHTML = "";
        rows.forEach(({price, qty, _cum}) => {
            const tr = document.createElement("tr");
            tr.className = isAsk ? "row-sell" : "row-buy";
            tr.innerHTML = `
      <td class="price">${fmt(price, 2)}</td>
      <td class="qty">${fmt(qty, 4)}</td>
      <td class="qty mono">${fmt(_cum, 4)}</td>
    `;
            tbody.appendChild(tr);
        });
    }

    // 启动
    connectDepth();


    /** -----------------------
     *  Order form (提交到后端)
     *  ----------------------*/
    // 下单函数 与事件绑定
    async function submitOrder(side) {
        const type = document.getElementById('type').value;
        const tif = document.getElementById('tif').value;
        const price = parseFloat(document.getElementById('price').value || '0');
        const qty = parseFloat(document.getElementById('qty').value || '0');

        if (!qty || (type === 'LIMIT' && !price)) {
            alert('请填写价格/数量');
            return;
        }

        const order = {
            userId: 1,
            orderId: Math.round(Math.random() * 100000000),
            symbol: "BTCUSDT",
            type: type,       // LIMIT / MARKET / STOP
            tif: tif,         // GTC / IOC / FOK
            side: side,       // BID / ASK
            price: type === 'MARKET' ? 0 : price,
            qty: qty
        };

        try {
            // 字节流传输下单接口 http://localhost:8080/api/order.bin
            const res = await fetch("http://localhost:8080/api/order", {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify(order)
            });
            if (!res.ok) {
                const txt = await res.text();
                throw new Error(txt || "下单失败");
            }

            await res.json().catch(() => ({}));
            alert("下单成功 ✅\n订单号: " + order.orderId);
            // document.getElementById('orderForm').reset();

            // 可选：把订单当作成交推送到前端演示
            // pushTrade({time: Date.now(), price: price || 0, qty, side});

        } catch (err) {
            alert("下单失败 ❌: " + err.message);
        }
    }

    document.getElementById('btnBuy').addEventListener('click', () => submitOrder('BID'));
    document.getElementById('btnSell').addEventListener('click', () => submitOrder('ASK'));


    /** -----------------------
     *  trades 历史
     *  ----------------------*/
    async function loadTrades() {
        try {
            const res = await fetch("http://localhost:8080/api/order/trades");
            if (!res.ok) throw new Error("HTTP " + res.status);
            const trades = await res.json();

            const tb = document.querySelector('#trades tbody');
            tb.innerHTML = "";

            trades.forEach(t => {
                const sideClass = t.takerSide === 'BUY' ? 'side-b' : 'side-s';
                const ms = t.tradeTime > 1e12 ? t.tradeTime : t.tradeTime * 1000;

                const tr = document.createElement('tr');
                tr.innerHTML = `
        <td style="text-align:left">${t.symbol}</td>
        <td class="mono">${t.takerOrderId}</td>
        <td class="${sideClass}">${t.takerSide}</td>
        <td class="mono">${t.makerOrderId}</td>
        <td class="mono">${fmt(t.price, 2)}</td>
        <td class="mono">${fmt(t.qty, 4)}</td>
        <td class="mono">${new Date(ms).toLocaleString()}</td>
      `;
                tb.appendChild(tr);
            });
        } catch (err) {
            console.error("加载成交失败:", err);
        }
    }

    // 页面加载完就拉一次
    loadTrades();
    setInterval(loadTrades, 5000);


    //todo K线获取
</script>
</body>
</html>
